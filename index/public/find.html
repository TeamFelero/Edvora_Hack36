<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Find Nearby Educational Institutions</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f7fa;
      color: #333;
    }

    h2 {
      text-align: center;
      margin: 20px 0 10px;
      font-size: 1.8em;
      color: #2c3e50;
    }

    #controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px 20px;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #controls input,
    #controls select,
    #controls button {
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1em;
      outline: none;
    }

    #controls input:focus,
    #controls select:focus {
      border-color: #2980b9;
    }

    #controls button {
      background-color: #2980b9;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #controls button:hover {
      background-color: #1c5980;
    }

    #map {
      height: 500px;
      width: 90%;
      max-width: 1000px;
      margin: 20px auto;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    #cityInfo {
      text-align: center;
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #ffffff;
      width: 90%;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    #cityInfo h3 {
      margin-bottom: 5px;
      color: #2c3e50;
    }

    #cityInfo p {
      margin: 0;
      line-height: 1.5;
    }
  </style>
</head>
<body>

  <h2>Find Nearby Educational Institutions</h2>

  <div id="controls">
    <input type="text" id="cityInput" placeholder="Enter city name" />
    <select id="typeSelect">
      <option value="college">College</option>
      <option value="university">University</option>
    </select>
    <button onclick="searchByCity()">Search</button>
    <button onclick="searchNearby()">College Near Me</button>
  </div>

  <div id="cityInfo"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    let map;
    let resultsLayer;

    async function searchByCity() {
      const city = document.getElementById("cityInput").value.trim();
      const type = document.getElementById("typeSelect").value;

      if (!city) {
        alert("Please enter a city name.");
        return;
      }

      const geoUrl = `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(city)}`;
      const geoRes = await fetch(geoUrl);
      const geoData = await geoRes.json();

      if (!geoData || geoData.length === 0) {
        alert("City not found.");
        return;
      }

      const cityData = geoData[0];
      const lat = parseFloat(cityData.lat);
      const lon = parseFloat(cityData.lon);
      const displayName = cityData.display_name;
      const typeName = cityData.type || "unknown";
      const address = cityData.address || {};
      const region = address.state || address.region || address.county || "Unknown Region";
      const country = address.country || "Unknown Country";

      document.getElementById("cityInfo").innerHTML = `
        <h3>üåÜ ${displayName}</h3>
        <p>
          <strong>Type:</strong> ${typeName.charAt(0).toUpperCase() + typeName.slice(1)}<br>
          <strong>Region:</strong> ${region}<br>
          <strong>Country:</strong> ${country}<br>
          <strong>Coordinates:</strong> ${lat.toFixed(4)}, ${lon.toFixed(4)}
        </p>
      `;

      updateMapAndMarkers(lat, lon, type);
    }

    async function searchNearby() {
      const type = document.getElementById("typeSelect").value;

      if (!navigator.geolocation) {
        alert("Geolocation is not supported by your browser.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async position => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          const accuracy = position.coords.accuracy;

          console.log("Accuracy: ", accuracy);  

          const reverseUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&addressdetails=1`;
          const reverseRes = await fetch(reverseUrl);
          const reverseData = await reverseRes.json();

          const address = reverseData.address || {};
          const displayName = reverseData.display_name || "Your Location";
          const region = address.state || address.region || address.county || "Unknown Region";
          const country = address.country || "Unknown Country";

          document.getElementById("cityInfo").innerHTML = `
            <h3>üìç You are near: ${displayName}</h3>
            <p>
              <strong>Region:</strong> ${region}<br>
              <strong>Country:</strong> ${country}<br>
              <strong>Coordinates:</strong> ${lat.toFixed(4)}, ${lon.toFixed(4)}
            </p>
          `;

          updateMapAndMarkers(lat, lon, type);
        },
        error => {
          alert("Unable to retrieve your location.");
        },
        {
          enableHighAccuracy: true, 
          timeout: 5000,            
          maximumAge: 0              
        }
      );
    }

    async function updateMapAndMarkers(lat, lon, type) {
      if (!map) {
        map = L.map('map').setView([lat, lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      } else {
        map.setView([lat, lon], 13);
        if (resultsLayer) resultsLayer.clearLayers();
      }

      const radius = 5000;
      const query = `
        [out:json];
        (
          node["amenity"="${type}"](around:${radius},${lat},${lon});
          way["amenity"="${type}"](around:${radius},${lat},${lon});
          relation["amenity"="${type}"](around:${radius},${lat},${lon});
        );
        out center;
      `;
      const overpassUrl = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);
      const res = await fetch(overpassUrl);
      const data = await res.json();

      const elements = data.elements;
      const markers = [];

      if (elements.length === 0) {
        alert("No institutions found nearby.");
        return;
      }

      elements.forEach(el => {
        const elLat = el.lat || el.center?.lat;
        const elLon = el.lon || el.center?.lon;
        if (elLat && elLon) {
          const tags = el.tags || {};
          const name = tags.name || "Unnamed";
          const operator = tags.operator || "Unknown Operator";
          const popupContent = `
            <b>${name}</b><br>
            Type: ${type}<br>
            Operator: ${operator}
          `;
          markers.push(L.marker([elLat, elLon]).bindPopup(popupContent));
        }
      });

      resultsLayer = L.layerGroup(markers).addTo(map);
    }
  </script>

</body>
</html>

